schema_version: "0.5.0"

before_install:

  appveyor:
    environment:
      PATH: $<PYTHON_DIR>;$<PYTHON_DIR>\\Scripts;$<PATH>
      RUN_ENV: .\\..\\addons\\appveyor\\run-with-visual-studio.cmd
    commands:
      - python ../addons/appveyor/patch_vs2008.py
      - python ../addons/appveyor/install_cmake.py 3.6.2

  circle:
    environment:
      PATH: /opt/python/$<MANYLINUX_PYTHON>/bin:$<PATH>
    commands:
      - rm -rf dist/*

  travis:
    osx:
      environment:
        PATH: $<HOME>/.pyenv/versions/$<PYTHONVERSION>/bin:$<PATH>
      commands:
        - python ../addons/travis/install_pyenv.py
        - python ../addons/travis/install_cmake.py 3.6.2

install:
  commands:
    - python --version
    - python -m pip install --disable-pip-version-check --upgrade pip
    - $<RUN_ENV> pip install -r requirements-dev.txt
  travis:
    osx:
      commands:
        - ls $<HOME>/.pyenv/versions/$<PYTHONVERSION>/bin/
        - $<HOME>/.pyenv/versions/$<PYTHONVERSION>/bin/python --version
        - export

before_build:
  commands:
    - flake8

build:
  commands:
    - python setup.py --hide-listing sdist
    - $<RUN_ENV> python setup.py --hide-listing bdist_wheel

after_test:
  commands:
    - pip install girder-client==2.0.0
    - python: |
              import girder_client, os, subprocess
              if 'GIRDER_TOKEN' in os.environ:
                  token = os.environ['GIRDER_TOKEN']
                  subprocess.check_call(
                    "python -m girder_client --api-url https://data.kitware.com/api/v1 --api-key {token} \
                      upload --parent-type collection --reuse 5817c33a8d777f10f26ee3a7 ./dist/".format(token=token),
                    shell=True)
              else:
                  print("Skipping upload: GIRDER_TOKEN environment variable is not set")
    - $<RUN_ENV> python setup.py clean
